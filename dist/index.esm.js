import _forEachInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/for-each";import _concatInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/concat";import _classCallCheck from"@babel/runtime-corejs3/helpers/classCallCheck";import _createClass from"@babel/runtime-corejs3/helpers/createClass";import _defineProperty from"@babel/runtime-corejs3/helpers/defineProperty";import"@babel/runtime-corejs3/regenerator";import"@babel/runtime-corejs3/core-js-stable/set-timeout";import"@babel/runtime-corejs3/core-js-stable/promise";import _sliceInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/slice";import _Object$getOwnPropertyNames from"@babel/runtime-corejs3/core-js-stable/object/get-own-property-names";import"@babel/runtime-corejs3/helpers/asyncToGenerator";import _spliceInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/splice";import _indexOfInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/index-of";import _toConsumableArray from"@babel/runtime-corejs3/helpers/toConsumableArray";import _Map from"@babel/runtime-corejs3/core-js-stable/map";import _bindInstanceProperty from"@babel/runtime-corejs3/core-js-stable/instance/bind";import _Object$create from"@babel/runtime-corejs3/core-js-stable/object/create";var Global=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"_debugMode",void 0),this._debugMode=!1}return _createClass(e,[{key:"debug",get:function(){return this._debugMode},set:function(e){this._debugMode=e}}]),e}(),global=new Global;function safeLog(){try{var e;(e=console).log.apply(e,arguments)}catch(e){console.warn(e)}}function isClass(e){if("function"!=typeof e)return!1;if(void 0===e.prototype)return!1;if(e.prototype.constructor!==e)return!1;if(_Object$getOwnPropertyNames(e.prototype).length>=2)return!0;var t=String(e);if("class"==_sliceInstanceProperty(t).call(t,0,5))return!0;if(/^function\s*\(|^function anonymous\(/.test(t))return!1;var n=/(call|apply|_classCallCheck)\(this(, arguments)?\)|\bthis(.\S+|\[.+?\])\s*(=|\()|=\s*this[,;]/.test(t);return!(!/^function\s+[A-Z]/.test(t)||!(n||/\[native code\]/.test(t)&&"BigInt"!==e.name&&"Symbol"!==e.name))||!(!n||"default_1"!==e.name)}function hackTimer(e){var t=e.setInterval,n=e.setTimeout,r=[],o=[];return{hookSetInterval:function(e,n){for(var r,a=arguments.length,c=new Array(a>2?a-2:0),i=2;i<a;i++)c[i-2]=arguments[i];var s=t.apply(void 0,_concatInstanceProperty(r=[e,n]).call(r,c));return o.push(s),global.debug&&safeLog("Call setInterval. intervalId: ".concat(s)),s},hookSetTimeout:function(e,t){for(var o,a=arguments.length,c=new Array(a>2?a-2:0),i=2;i<a;i++)c[i-2]=arguments[i];var s=n.apply(void 0,_concatInstanceProperty(o=[e,t]).call(o,c));return r.push(s),global.debug&&safeLog("Call setTimeout. timerId: ".concat(s)),s},reset:function(){_forEachInstanceProperty(r).call(r,(function(t){e.clearTimeout(t),global.debug&&safeLog("ClearTimeout. timerId: ".concat(t))})),_forEachInstanceProperty(o).call(o,(function(t){e.clearInterval(t),global.debug&&safeLog("ClearInterval. intervalId: ".concat(t))}))}}}function hackEventListener(e){var t=e.addEventListener,n=e.removeEventListener,r=new _Map,o=function(t,o,a){var c,i=r.get(t);(i&&i.length&&-1!==_indexOfInstanceProperty(i).call(i,o)&&_spliceInstanceProperty(i).call(i,_indexOfInstanceProperty(i).call(i,o),1),global.debug)&&safeLog(_concatInstanceProperty(c="Call removeEventListener. eventName: ".concat(t,"; eventHandler: ")).call(c,o?o.toString():"null"));return n.call(e,t,o,a)};return{hookAddEventListener:function(n,o,a){var c,i,s=r.get(n)||[];(r.set(n,_concatInstanceProperty(c=[]).call(c,_toConsumableArray(s),[o])),global.debug)&&safeLog(_concatInstanceProperty(i="Call addEventListener. eventName: ".concat(n,"; eventHandler: ")).call(i,o?o.toString():"null"));return t.call(e,n,o,a)},hookRemoveEventListener:o,reset:function(){_forEachInstanceProperty(r).call(r,(function(e,t){var n;return _forEachInstanceProperty(n=_toConsumableArray(e)).call(n,(function(e){return o(t,e)}))}))}}}function createSandbox(e){var t,n=new _Map,r=new _Map,o=new _Map,a=e,c=_Object$create(null);return{sandbox:new Proxy(c,{get:function(e,n){if(t){var r=t(a,n);if(void 0!==r)return r}var o=a[n];return"function"!=typeof o||isClass(o)||(o=_bindInstanceProperty(o).call(o,a)),o},set:function(t,c,i){if(r.has(c)?r.set(c,i):o.has(c)?o.set(c,i):Object.prototype.hasOwnProperty.call(a,c)?(n.set(c,a[c]),o.set(c,i)):r.set(c,i),a[c]=i,global.debug){var s,l="";e instanceof Window?l="window":e instanceof Document?l="document":e instanceof HTMLElement&&(l=e.tagName),safeLog("Set ",_concatInstanceProperty(s="".concat(l,".")).call(s,c.toString()," to "),i,"! Original value is ",n.get(c))}return!0},has:function(e,t){return t in a}}),reset:function(){_forEachInstanceProperty(r).call(r,(function(e,t){delete a[t]})),_forEachInstanceProperty(o).call(o,(function(e,t){a[t]=n.get(t)})),r.clear(),o.clear(),n.clear()},setGetProperty:function(e){t=e}}}var index={set debug(e){global.debug=e},create:function create(source){var windowProxy=createSandbox(window),timerWatcher=hackTimer(window),eventWatcherOfWindow=hackEventListener(window),eventWatcherOfDocument=hackEventListener(window.document),eventWatcherOfBody=hackEventListener(window.document.body);return windowProxy.setGetProperty((function(e,t){return"top"===t||"window"===t||"self"===t?windowProxy.sandbox:"setInterval"===t?timerWatcher.hookSetInterval:"setTimeout"===t?timerWatcher.hookSetTimeout:"addEventListener"===t?eventWatcherOfWindow.hookAddEventListener:"removeEventListener"===t?eventWatcherOfWindow.hookRemoveEventListener:"Promise"===t?e.Promise:"Object"===t?e.Object:void 0})),windowProxy.sandbox.document.addEventListener=eventWatcherOfDocument.hookAddEventListener,windowProxy.sandbox.document.removeEventListener=eventWatcherOfDocument.hookRemoveEventListener,windowProxy.sandbox.document.body.addEventListener=eventWatcherOfBody.hookAddEventListener,windowProxy.sandbox.document.body.removeEventListener=eventWatcherOfBody.hookRemoveEventListener,{mount:function mount(){var wrapperFunction=function wrapperFunction(window,setInterval,setTimeout){return eval(source)};return wrapperFunction.call(windowProxy.sandbox,windowProxy.sandbox,timerWatcher.hookSetInterval,timerWatcher.hookSetTimeout)},mountWithCommonjs:function mountWithCommonjs(module,exports,require){var wrapperFunction=function wrapperFunction(window,setInterval,setTimeout,module,exports,require){eval(source)};wrapperFunction.call(windowProxy.sandbox,windowProxy.sandbox,timerWatcher.hookSetInterval,timerWatcher.hookSetTimeout,module,exports,require)},unmount:function(){var e;_forEachInstanceProperty(e=[windowProxy,timerWatcher,eventWatcherOfWindow,eventWatcherOfDocument,eventWatcherOfBody]).call(e,(function(e){e.reset()}))}}}};export default index;
